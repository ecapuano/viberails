name: Build

on:
    push:
        branches: ["**"]
        tags: ["v*"]
    pull_request:
        branches: ["**"]
    workflow_dispatch:
        inputs:
            code_signing:
                description: "Enable code signing"
                required: false
                default: false
                type: boolean
            skip_tests:
                description: "Skip tests"
                required: false
                default: false
                type: boolean

env:
    CARGO_TERM_COLOR: always

jobs:
    test:
        if: inputs.skip_tests != true
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Run tests
              run: cargo test --all-features

    build:
        needs: test
        if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-musl
                      artifact: viberails-linux-x64
                    - os: ubuntu-latest
                      target: aarch64-unknown-linux-musl
                      artifact: viberails-linux-arm64
                    - os: macos-latest
                      target: x86_64-apple-darwin
                      artifact: viberails-macos-x64
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      artifact: viberails-macos-arm64
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact: viberails-windows-x64
                    - os: windows-latest
                      target: aarch64-pc-windows-msvc
                      artifact: viberails-windows-arm64

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Install musl tools (Linux x64)
              if: matrix.target == 'x86_64-unknown-linux-musl'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y musl-tools

            - name: Install cross-compilation tools (Linux ARM64 musl)
              if: matrix.target == 'aarch64-unknown-linux-musl'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y musl-tools gcc-aarch64-linux-gnu musl-dev
                  sudo ln -sf /usr/bin/aarch64-linux-gnu-gcc /usr/bin/aarch64-linux-musl-gcc

            - name: Build
              run: cargo build --release --target ${{ matrix.target }}
              env:
                  CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER: aarch64-linux-gnu-gcc

            - name: Rename binary (Unix)
              if: runner.os != 'Windows'
              run: |
                  mv target/${{ matrix.target }}/release/viberails ${{ matrix.artifact }}

            - name: Rename binary (Windows)
              if: runner.os == 'Windows'
              run: |
                  mv target/${{ matrix.target }}/release/viberails.exe ${{ matrix.artifact }}.exe

            - name: Upload artifact (Unix)
              if: runner.os != 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}

            - name: Upload artifact (Windows)
              if: runner.os == 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}.exe

    dist:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist
                  merge-multiple: true

            - name: Prepare distribution
              run: |
                  # Copy install scripts
                  cp installer/install.sh dist/
                  cp installer/install.ps1 dist/
                  cp installer/join.ps1 dist/

                  # Create entitlements archive
                  mkdir -p entitlements
                  cp signing/entitlements/viberails-macos-arm64.plist entitlements/
                  cp signing/entitlements/viberails-macos-x86.plist entitlements/
                  zip -r dist/entitlements.zip entitlements

                  # Determine version
                  VERSION="${GITHUB_REF_NAME}"
                  if [[ ! "$VERSION" =~ ^v ]]; then
                      VERSION="${GITHUB_SHA:0:7}"
                  fi
                  TIMESTAMP=$(date +%s)

                  # Compute SHA256 checksums for all binaries
                  declare -A CHECKSUMS
                  for file in dist/viberails-*; do
                      filename=$(basename "$file")
                      checksum=$(sha256sum "$file" | cut -d' ' -f1)
                      CHECKSUMS["$filename"]="$checksum"
                  done

                  # Build checksums JSON object
                  CHECKSUMS_JSON="{"
                  first=true
                  for key in "${!CHECKSUMS[@]}"; do
                      if [ "$first" = true ]; then
                          first=false
                      else
                          CHECKSUMS_JSON+=","
                      fi
                      CHECKSUMS_JSON+="\"$key\":\"${CHECKSUMS[$key]}\""
                  done
                  CHECKSUMS_JSON+="}"

                  # Create release.json with version and checksums
                  echo "{\"version\": \"$VERSION\", \"timestamp\": $TIMESTAMP, \"commit\": \"$GITHUB_SHA\", \"checksums\": $CHECKSUMS_JSON}" > dist/release.json

                  # Display release.json for verification
                  echo "Generated release.json:"
                  cat dist/release.json | jq .

            - name: Upload distribution
              uses: actions/upload-artifact@v4
              with:
                  name: viberails-dist
                  path: dist/

    code-sign:
        needs: dist
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/') || inputs.code_signing

        steps:
            - uses: actions/checkout@v4

            - name: Download distribution artifacts
              uses: actions/download-artifact@v4
              with:
                  name: viberails-dist
                  path: dist

            - name: Create distribution zip
              run: |
                  cd dist
                  zip -r ../viberails-dist.zip .

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.x"

            - name: Install signing dependencies
              run: pip install -r signing/requirements.txt

            - name: Code sign
              run: python signing/client.py --timeout 120 --base64-key ${{ secrets.CODE_SIGNING_KEY }} -i viberails-dist.zip

            - name: Extract signed distribution
              run: |
                  rm -rf dist
                  unzip viberails-dist.zip -d dist

            - name: Upload signed distribution
              uses: actions/upload-artifact@v4
              with:
                  name: viberails-dist-signed
                  path: dist/

    release:
        needs: [dist, code-sign]
        runs-on: ubuntu-latest
        if: always() && startsWith(github.ref, 'refs/tags/') && needs.dist.result == 'success' && (needs.code-sign.result == 'success' || needs.code-sign.result == 'skipped')

        steps:
            - name: Download signed distribution artifacts
              if: needs.code-sign.result == 'success'
              uses: actions/download-artifact@v4
              with:
                  name: viberails-dist-signed
                  path: dist

            - name: Download unsigned distribution artifacts
              if: needs.code-sign.result == 'skipped'
              uses: actions/download-artifact@v4
              with:
                  name: viberails-dist
                  path: dist

            - name: List distribution contents
              run: ls -la dist/

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.LC_VIBERAILS_GHA_SA }}

            - name: Upload to GCS (latest)
              uses: google-github-actions/upload-cloud-storage@v2
              with:
                  path: dist
                  destination: get-viberails
                  parent: false

            - name: Upload to GCS (versioned)
              uses: google-github-actions/upload-cloud-storage@v2
              with:
                  path: dist
                  destination: get-viberails/${{ github.ref_name }}
                  parent: false
