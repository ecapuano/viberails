name: Build

on:
    push:
        branches: ["**"]
    pull_request:
        branches: ["**"]
    workflow_dispatch:

env:
    CARGO_TERM_COLOR: always

jobs:
    test:
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Run tests
              working-directory: viberails
              run: cargo test --all-features

    build:
        needs: test
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-musl
                      artifact: viberails-linux-x64
                    - os: ubuntu-latest
                      target: aarch64-unknown-linux-musl
                      artifact: viberails-linux-arm64
                    - os: macos-latest
                      target: x86_64-apple-darwin
                      artifact: viberails-macos-x64
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      artifact: viberails-macos-arm64
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact: viberails-windows-x64

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Install musl tools (Linux x64)
              if: matrix.target == 'x86_64-unknown-linux-musl'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y musl-tools

            - name: Install cross-compilation tools (Linux ARM64 musl)
              if: matrix.target == 'aarch64-unknown-linux-musl'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y musl-tools gcc-aarch64-linux-gnu musl-dev
                  sudo ln -sf /usr/bin/aarch64-linux-gnu-gcc /usr/bin/aarch64-linux-musl-gcc

            - name: Build
              working-directory: viberails
              run: cargo build --release --target ${{ matrix.target }}
              env:
                  CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER: aarch64-linux-gnu-gcc

            - name: Rename binary (Unix)
              if: runner.os != 'Windows'
              run: |
                  mv viberails/target/${{ matrix.target }}/release/viberails ${{ matrix.artifact }}

            - name: Rename binary (Windows)
              if: runner.os == 'Windows'
              run: |
                  mv viberails/target/${{ matrix.target }}/release/viberails.exe ${{ matrix.artifact }}.exe

            - name: Upload artifact (Unix)
              if: runner.os != 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}

            - name: Upload artifact (Windows)
              if: runner.os == 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}.exe

    dist:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist

            - name: Prepare distribution
              run: |
                  # Move binaries from subdirectories to dist root
                  find dist -mindepth 2 -type f -exec mv {} dist/ \;
                  # Remove empty artifact directories
                  rm -rf dist/*/
                  # Copy install script
                  cp installer/install.sh dist/

            - name: Upload distribution
              uses: actions/upload-artifact@v4
              with:
                  name: viberails-dist
                  path: dist/
