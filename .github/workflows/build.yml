name: Build

on:
    push:
        branches: ["master"]
        tags: ["v*"]
    pull_request:
        branches: ["master"]
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Dry run: execute full pipeline (build, dist, sign) but skip the release upload"
                required: false
                default: false
                type: boolean
            code_signing:
                description: "Enable code signing"
                required: false
                default: false
                type: boolean
            skip_tests:
                description: "Skip tests"
                required: false
                default: false
                type: boolean

# Restrict permissions to minimum required for this workflow.
# All jobs only need read access to checkout the repository.
permissions:
    contents: read

# Prevent concurrent runs for the same branch/tag to avoid race conditions.
# For PRs and branches, cancel in-progress runs when new commits are pushed.
# For tags (releases), allow the run to complete to avoid partial releases.
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ !startsWith(github.ref, 'refs/tags/') }}

env:
    CARGO_TERM_COLOR: always
    # Authenticate API requests to avoid 429 rate limits when downloading
    # action tarballs (unauthenticated: 60 req/hr, authenticated: 1000 req/hr)
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
    test:
        if: inputs.skip_tests != true
        timeout-minutes: 10
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Install Rust toolchain
              # Pin non-official action to SHA for supply chain security
              uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
              with:
                  toolchain: stable

            - name: Cache cargo registry and build
              uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-test-

            - name: Run unit tests
              run: cargo test --all-features

    e2e-test:
        if: inputs.skip_tests != true
        timeout-minutes: 10
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
              with:
                  # Full clone so build.rs can determine version via git describe
                  fetch-depth: 0

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
              with:
                  toolchain: stable

            - name: Cache cargo registry and build
              uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-e2e-

            - name: Build binary for e2e tests
              run: cargo build

            - name: Setup bats
              uses: bats-core/bats-action@e412797c46257a2dbf3775f6f6010b33ee6cb99f # v3.0.1

            - name: Run e2e tests
              timeout-minutes: 5
              shell: bash
              env:
                  TERM: xterm
              run: |
                  chmod +x tests/e2e/*.bats tests/e2e/*.sh tests/e2e/*.bash 2>/dev/null || true
                  bats --timing tests/e2e/*.bats

    build:
        needs: [test, e2e-test]
        timeout-minutes: 10
        if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.e2e-test.result == 'success' || needs.e2e-test.result == 'skipped')
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-musl
                      artifact: viberails-linux-x64
                    - os: ubuntu-latest
                      target: aarch64-unknown-linux-musl
                      artifact: viberails-linux-arm64
                    - os: macos-latest
                      target: x86_64-apple-darwin
                      artifact: viberails-macos-x64
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      artifact: viberails-macos-arm64
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact: viberails-windows-x64
                    - os: windows-latest
                      target: aarch64-pc-windows-msvc
                      artifact: viberails-windows-arm64

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Install Rust toolchain
              # Pin non-official action to SHA for supply chain security
              uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
              with:
                  toolchain: stable
                  targets: ${{ matrix.target }}

            - name: Cache cargo registry and build
              uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-${{ matrix.target }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-${{ matrix.target }}-cargo-build-

            - name: Install musl tools (Linux x64)
              if: matrix.target == 'x86_64-unknown-linux-musl'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y musl-tools

            - name: Install cross-compilation tools (Linux ARM64 musl)
              if: matrix.target == 'aarch64-unknown-linux-musl'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y musl-tools gcc-aarch64-linux-gnu musl-dev
                  sudo ln -sf /usr/bin/aarch64-linux-gnu-gcc /usr/bin/aarch64-linux-musl-gcc

            - name: Build
              run: cargo build --release --target ${{ matrix.target }}
              env:
                  CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER: aarch64-linux-gnu-gcc

            - name: Rename binary (Unix)
              if: runner.os != 'Windows'
              run: |
                  mv target/${{ matrix.target }}/release/viberails ${{ matrix.artifact }}

            - name: Rename binary (Windows)
              if: runner.os == 'Windows'
              run: |
                  mv target/${{ matrix.target }}/release/viberails.exe ${{ matrix.artifact }}.exe

            - name: Upload artifact (Unix)
              if: runner.os != 'Windows'
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}

            - name: Upload artifact (Windows)
              if: runner.os == 'Windows'
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}.exe

    dist:
        needs: build
        timeout-minutes: 5
        if: always() && needs.build.result == 'success'
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Download all artifacts
              uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
              with:
                  path: dist
                  merge-multiple: true

            - name: Prepare distribution
              run: |
                  # Copy install scripts
                  cp installer/install.sh dist/
                  cp installer/install.ps1 dist/
                  cp installer/join.ps1 dist/

                  # Create entitlements archive
                  mkdir -p entitlements
                  cp signing/entitlements/*.plist entitlements/
                  zip -r dist/entitlements.zip entitlements

                  # Determine version
                  VERSION="${GITHUB_REF_NAME}"
                  if [[ ! "$VERSION" =~ ^v ]]; then
                      VERSION="${GITHUB_SHA:0:7}"
                  fi
                  TIMESTAMP=$(date +%s)

                  # Build checksums JSON object using jq to prevent injection
                  CHECKSUMS_JSON='{}'
                  for file in dist/viberails-*; do
                      filename=$(basename "$file")
                      checksum=$(sha256sum "$file" | cut -d' ' -f1)
                      # Use jq with --arg to safely escape values
                      CHECKSUMS_JSON=$(echo "$CHECKSUMS_JSON" | jq --arg k "$filename" --arg v "$checksum" '. + {($k): $v}')
                  done

                  # Create release.json using jq for safe JSON construction
                  jq -n \
                      --arg version "$VERSION" \
                      --arg timestamp "$TIMESTAMP" \
                      --arg commit "$GITHUB_SHA" \
                      --argjson checksums "$CHECKSUMS_JSON" \
                      '{version: $version, timestamp: ($timestamp | tonumber), commit: $commit, checksums: $checksums}' \
                      > dist/release.json

                  # Display release.json for verification
                  echo "Generated release.json:"
                  cat dist/release.json

            - name: Upload distribution
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
              with:
                  name: viberails-dist
                  path: dist/

    code-sign:
        needs: dist
        timeout-minutes: 15
        runs-on: ubuntu-latest
        # No environment gate - signing runs automatically on tags.
        # Approval is required on the release job before publishing.
        if: always() && needs.dist.result == 'success' && (startsWith(github.ref, 'refs/tags/') || inputs.code_signing == true)

        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

            - name: Download distribution artifacts
              uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
              with:
                  name: viberails-dist
                  path: dist

            - name: Create distribution zip
              run: |
                  cd dist
                  zip -r ../viberails-dist.zip .

            - name: Set up Python
              uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
              with:
                  python-version: "3.12"

            - name: Install signing dependencies
              # Use lockfile with hashes for supply chain security
              run: pip install --require-hashes -r signing/requirements.lock

            - name: Code sign
              run: python signing/client.py --timeout 600 -i viberails-dist.zip
              env:
                  CODE_SIGNING_KEY_B64: ${{ secrets.CODE_SIGNING_KEY }}

            - name: Extract signed distribution
              run: |
                  rm -rf dist
                  unzip viberails-dist.zip -d dist

            - name: Remove entitlements.zip from distribution
              run: rm -f dist/entitlements.zip

            - name: Regenerate checksums after signing
              run: |
                  # Read existing release.json to preserve version, timestamp, commit
                  VERSION=$(jq -r '.version' dist/release.json)
                  TIMESTAMP=$(jq -r '.timestamp' dist/release.json)
                  COMMIT=$(jq -r '.commit' dist/release.json)

                  # Build checksums JSON object using jq to prevent injection
                  CHECKSUMS_JSON='{}'
                  for file in dist/viberails-*; do
                      filename=$(basename "$file")
                      checksum=$(sha256sum "$file" | cut -d' ' -f1)
                      # Use jq with --arg to safely escape values
                      CHECKSUMS_JSON=$(echo "$CHECKSUMS_JSON" | jq --arg k "$filename" --arg v "$checksum" '. + {($k): $v}')
                  done

                  # Update release.json using jq for safe JSON construction
                  jq -n \
                      --arg version "$VERSION" \
                      --arg timestamp "$TIMESTAMP" \
                      --arg commit "$COMMIT" \
                      --argjson checksums "$CHECKSUMS_JSON" \
                      '{version: $version, timestamp: ($timestamp | tonumber), commit: $commit, checksums: $checksums}' \
                      > dist/release.json

                  # Display updated release.json for verification
                  echo "Updated release.json with post-signing checksums:"
                  cat dist/release.json

            - name: Upload signed distribution
              uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
              with:
                  name: viberails-dist-signed
                  path: dist/

    release:
        needs: [dist, code-sign]
        timeout-minutes: 10
        runs-on: ubuntu-latest
        # Use 'release' environment for manual approval gate before publishing.
        # Configure this environment in repo Settings -> Environments with required reviewers.
        environment: release
        if: always() && startsWith(github.ref, 'refs/tags/') && inputs.dry_run != true && needs.dist.result == 'success' && (needs.code-sign.result == 'success' || needs.code-sign.result == 'skipped')

        steps:
            - name: Download signed distribution artifacts
              if: needs.code-sign.result == 'success'
              uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
              with:
                  name: viberails-dist-signed
                  path: dist

            - name: Download unsigned distribution artifacts
              if: needs.code-sign.result == 'skipped'
              uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
              with:
                  name: viberails-dist
                  path: dist

            - name: Remove entitlements.zip from distribution
              run: rm -f dist/entitlements.zip

            - name: List distribution contents
              run: ls -la dist/

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2
              with:
                  credentials_json: ${{ secrets.LC_VIBERAILS_GHA_SA }}

            - name: Upload to GCS (latest)
              uses: google-github-actions/upload-cloud-storage@c0f6160ff80057923ff50e5e567695cea181ec23 # v2
              with:
                  path: dist
                  destination: get-viberails
                  parent: false

            - name: Upload to GCS (versioned)
              uses: google-github-actions/upload-cloud-storage@c0f6160ff80057923ff50e5e567695cea181ec23 # v2
              with:
                  path: dist
                  destination: get-viberails/archive/${{ github.ref_name }}
                  parent: false

            - name: Verify uploaded release.json
              env:
                  TAG: ${{ github.ref_name }}
              run: |
                  # Allow time for CDN propagation
                  sleep 5

                  BASE_URL="https://get.viberails.io"

                  echo "=== Verifying latest release.json ==="
                  LATEST_JSON=$(curl -fsSL "${BASE_URL}/release.json")

                  # Verify it's valid JSON
                  if ! echo "$LATEST_JSON" | jq empty 2>/dev/null; then
                      echo "ERROR: latest release.json is not valid JSON"
                      exit 1
                  fi
                  echo "✓ Valid JSON"

                  # Verify version matches tag
                  REMOTE_VERSION=$(echo "$LATEST_JSON" | jq -r '.version')
                  if [ "$REMOTE_VERSION" != "$TAG" ]; then
                      echo "ERROR: Version mismatch - expected '$TAG', got '$REMOTE_VERSION'"
                      exit 1
                  fi
                  echo "✓ Version matches: $REMOTE_VERSION"

                  # Verify checksums match local files
                  echo "Verifying checksums..."
                  for file in dist/viberails-*; do
                      filename=$(basename "$file")
                      local_checksum=$(sha256sum "$file" | cut -d' ' -f1)
                      remote_checksum=$(echo "$LATEST_JSON" | jq -r --arg f "$filename" '.checksums[$f] // empty')

                      if [ -z "$remote_checksum" ]; then
                          echo "ERROR: No checksum found for $filename in remote release.json"
                          exit 1
                      fi

                      if [ "$local_checksum" != "$remote_checksum" ]; then
                          echo "ERROR: Checksum mismatch for $filename"
                          echo "  Local:  $local_checksum"
                          echo "  Remote: $remote_checksum"
                          exit 1
                      fi
                      echo "✓ $filename checksum verified"
                  done

                  echo ""
                  echo "=== Verifying versioned release.json ==="
                  VERSIONED_JSON=$(curl -fsSL "${BASE_URL}/archive/${TAG}/release.json")

                  # Verify it's valid JSON and matches latest
                  if ! echo "$VERSIONED_JSON" | jq empty 2>/dev/null; then
                      echo "ERROR: versioned release.json is not valid JSON"
                      exit 1
                  fi
                  echo "✓ Valid JSON"

                  # Compare versioned with latest (should be identical)
                  if [ "$LATEST_JSON" != "$VERSIONED_JSON" ]; then
                      echo "ERROR: Versioned release.json differs from latest"
                      exit 1
                  fi
                  echo "✓ Versioned release.json matches latest"

                  echo ""
                  echo "=== All verifications passed ==="
