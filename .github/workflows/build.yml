name: Build

on:
    push:
        branches: ["master"]
        tags: ["v*"]
    pull_request:
        branches: ["master"]
    workflow_dispatch:
        inputs:
            code_signing:
                description: "Enable code signing"
                required: false
                default: false
                type: boolean
            skip_tests:
                description: "Skip tests"
                required: false
                default: false
                type: boolean

# Restrict permissions to minimum required for this workflow.
# All jobs only need read access to checkout the repository.
permissions:
    contents: read

# Prevent concurrent runs for the same branch/tag to avoid race conditions.
# For PRs and branches, cancel in-progress runs when new commits are pushed.
# For tags (releases), allow the run to complete to avoid partial releases.
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ !startsWith(github.ref, 'refs/tags/') }}

env:
    CARGO_TERM_COLOR: always

jobs:
    test:
        if: inputs.skip_tests != true
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              # Pin non-official action to SHA for supply chain security
              uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
              with:
                  toolchain: stable

            - name: Run tests
              run: cargo test --all-features

    build:
        needs: test
        if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-musl
                      artifact: viberails-linux-x64
                    - os: ubuntu-latest
                      target: aarch64-unknown-linux-musl
                      artifact: viberails-linux-arm64
                    - os: macos-latest
                      target: x86_64-apple-darwin
                      artifact: viberails-macos-x64
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      artifact: viberails-macos-arm64
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact: viberails-windows-x64
                    - os: windows-latest
                      target: aarch64-pc-windows-msvc
                      artifact: viberails-windows-arm64

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              # Pin non-official action to SHA for supply chain security
              uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
              with:
                  toolchain: stable
                  targets: ${{ matrix.target }}

            - name: Install musl tools (Linux x64)
              if: matrix.target == 'x86_64-unknown-linux-musl'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y musl-tools

            - name: Install cross-compilation tools (Linux ARM64 musl)
              if: matrix.target == 'aarch64-unknown-linux-musl'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y musl-tools gcc-aarch64-linux-gnu musl-dev
                  sudo ln -sf /usr/bin/aarch64-linux-gnu-gcc /usr/bin/aarch64-linux-musl-gcc

            - name: Build
              run: cargo build --release --target ${{ matrix.target }}
              env:
                  CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER: aarch64-linux-gnu-gcc

            - name: Rename binary (Unix)
              if: runner.os != 'Windows'
              run: |
                  mv target/${{ matrix.target }}/release/viberails ${{ matrix.artifact }}

            - name: Rename binary (Windows)
              if: runner.os == 'Windows'
              run: |
                  mv target/${{ matrix.target }}/release/viberails.exe ${{ matrix.artifact }}.exe

            - name: Upload artifact (Unix)
              if: runner.os != 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}

            - name: Upload artifact (Windows)
              if: runner.os == 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}.exe

    dist:
        needs: build
        if: always() && needs.build.result == 'success'
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist
                  merge-multiple: true

            - name: Prepare distribution
              run: |
                  # Copy install scripts
                  cp installer/install.sh dist/
                  cp installer/install.ps1 dist/
                  cp installer/join.ps1 dist/

                  # Create entitlements archive
                  mkdir -p entitlements
                  cp signing/entitlements/*.plist entitlements/
                  zip -r dist/entitlements.zip entitlements

                  # Determine version
                  VERSION="${GITHUB_REF_NAME}"
                  if [[ ! "$VERSION" =~ ^v ]]; then
                      VERSION="${GITHUB_SHA:0:7}"
                  fi
                  TIMESTAMP=$(date +%s)

                  # Build checksums JSON object using jq to prevent injection
                  CHECKSUMS_JSON='{}'
                  for file in dist/viberails-*; do
                      filename=$(basename "$file")
                      checksum=$(sha256sum "$file" | cut -d' ' -f1)
                      # Use jq with --arg to safely escape values
                      CHECKSUMS_JSON=$(echo "$CHECKSUMS_JSON" | jq --arg k "$filename" --arg v "$checksum" '. + {($k): $v}')
                  done

                  # Create release.json using jq for safe JSON construction
                  jq -n \
                      --arg version "$VERSION" \
                      --arg timestamp "$TIMESTAMP" \
                      --arg commit "$GITHUB_SHA" \
                      --argjson checksums "$CHECKSUMS_JSON" \
                      '{version: $version, timestamp: ($timestamp | tonumber), commit: $commit, checksums: $checksums}' \
                      > dist/release.json

                  # Display release.json for verification
                  echo "Generated release.json:"
                  cat dist/release.json

            - name: Upload distribution
              uses: actions/upload-artifact@v4
              with:
                  name: viberails-dist
                  path: dist/

    code-sign:
        needs: dist
        runs-on: ubuntu-latest
        # Use 'release' environment for manual approval gate before accessing signing secrets.
        # Configure this environment in repo Settings -> Environments with required reviewers.
        environment: release
        if: always() && needs.dist.result == 'success' && (startsWith(github.ref, 'refs/tags/') || inputs.code_signing == true)

        steps:
            - uses: actions/checkout@v4

            - name: Download distribution artifacts
              uses: actions/download-artifact@v4
              with:
                  name: viberails-dist
                  path: dist

            - name: Create distribution zip
              run: |
                  cd dist
                  zip -r ../viberails-dist.zip .

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.x"

            - name: Install signing dependencies
              run: pip install -r signing/requirements.txt

            - name: Code sign
              run: python signing/client.py --timeout 600 --base64-key ${{ secrets.CODE_SIGNING_KEY }} -i viberails-dist.zip

            - name: Extract signed distribution
              run: |
                  rm -rf dist
                  unzip viberails-dist.zip -d dist

            - name: Remove entitlements.zip from distribution
              run: rm -f dist/entitlements.zip

            - name: Regenerate checksums after signing
              run: |
                  # Read existing release.json to preserve version, timestamp, commit
                  VERSION=$(jq -r '.version' dist/release.json)
                  TIMESTAMP=$(jq -r '.timestamp' dist/release.json)
                  COMMIT=$(jq -r '.commit' dist/release.json)

                  # Build checksums JSON object using jq to prevent injection
                  CHECKSUMS_JSON='{}'
                  for file in dist/viberails-*; do
                      filename=$(basename "$file")
                      checksum=$(sha256sum "$file" | cut -d' ' -f1)
                      # Use jq with --arg to safely escape values
                      CHECKSUMS_JSON=$(echo "$CHECKSUMS_JSON" | jq --arg k "$filename" --arg v "$checksum" '. + {($k): $v}')
                  done

                  # Update release.json using jq for safe JSON construction
                  jq -n \
                      --arg version "$VERSION" \
                      --arg timestamp "$TIMESTAMP" \
                      --arg commit "$COMMIT" \
                      --argjson checksums "$CHECKSUMS_JSON" \
                      '{version: $version, timestamp: ($timestamp | tonumber), commit: $commit, checksums: $checksums}' \
                      > dist/release.json

                  # Display updated release.json for verification
                  echo "Updated release.json with post-signing checksums:"
                  cat dist/release.json

            - name: Upload signed distribution
              uses: actions/upload-artifact@v4
              with:
                  name: viberails-dist-signed
                  path: dist/

    release:
        needs: [dist, code-sign]
        runs-on: ubuntu-latest
        # Use 'release' environment for manual approval gate before publishing.
        # Configure this environment in repo Settings -> Environments with required reviewers.
        environment: release
        if: always() && startsWith(github.ref, 'refs/tags/') && needs.dist.result == 'success' && (needs.code-sign.result == 'success' || needs.code-sign.result == 'skipped')

        steps:
            - name: Download signed distribution artifacts
              if: needs.code-sign.result == 'success'
              uses: actions/download-artifact@v4
              with:
                  name: viberails-dist-signed
                  path: dist

            - name: Download unsigned distribution artifacts
              if: needs.code-sign.result == 'skipped'
              uses: actions/download-artifact@v4
              with:
                  name: viberails-dist
                  path: dist

            - name: Remove entitlements.zip from distribution
              run: rm -f dist/entitlements.zip

            - name: List distribution contents
              run: ls -la dist/

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.LC_VIBERAILS_GHA_SA }}

            - name: Upload to GCS (latest)
              uses: google-github-actions/upload-cloud-storage@v2
              with:
                  path: dist
                  destination: get-viberails
                  parent: false

            - name: Upload to GCS (versioned)
              uses: google-github-actions/upload-cloud-storage@v2
              with:
                  path: dist
                  destination: get-viberails/archive/${{ github.ref_name }}
                  parent: false
