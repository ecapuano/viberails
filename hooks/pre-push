#!/bin/bash

# Pre-push hook to validate that git tags match the version in Cargo.toml

# Read what's being pushed
while read local_ref local_sha remote_ref remote_sha; do
    # Check if we're pushing a tag
    if [[ "$remote_ref" == refs/tags/v* ]]; then
        # Extract version from tag (remove 'refs/tags/v' prefix)
        tag_version="${remote_ref#refs/tags/v}"

        # Extract version from Cargo.toml
        cargo_version=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')

        if [ "$tag_version" != "$cargo_version" ]; then
            echo "ERROR: Tag version (v$tag_version) does not match Cargo.toml version ($cargo_version)"
            echo "Please update Cargo.toml to version \"$tag_version\" before pushing this tag."
            exit 1
        fi

        echo "Tag version v$tag_version matches Cargo.toml version."
    fi
done

exit 0
