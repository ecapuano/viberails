name: Build

on:
    push:
        branches: ["**"]
    pull_request:
        branches: ["**"]
    workflow_dispatch:

env:
    CARGO_TERM_COLOR: always

jobs:
    test:
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable

            - name: Run tests
              run: cargo test --all-features

    build:
        needs: test
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      artifact: viberails-linux-x64
                    - os: ubuntu-latest
                      target: aarch64-unknown-linux-gnu
                      artifact: viberails-linux-arm64
                    - os: macos-latest
                      target: x86_64-apple-darwin
                      artifact: viberails-macos-x64
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      artifact: viberails-macos-arm64
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact: viberails-windows-x64

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Install cross-compilation tools (Linux ARM64)
              if: matrix.target == 'aarch64-unknown-linux-gnu'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc-aarch64-linux-gnu

            - name: Build
              run: cargo build --release --target ${{ matrix.target }}
              env:
                  CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

            - name: Rename binary (Unix)
              if: runner.os != 'Windows'
              run: |
                  mv target/${{ matrix.target }}/release/viberails ${{ matrix.artifact }}

            - name: Rename binary (Windows)
              if: runner.os == 'Windows'
              run: |
                  mv target/${{ matrix.target }}/release/viberails.exe ${{ matrix.artifact }}.exe

            - name: Upload artifact (Unix)
              if: runner.os != 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}

            - name: Upload artifact (Windows)
              if: runner.os == 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}.exe
